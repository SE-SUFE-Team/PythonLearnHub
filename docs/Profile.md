# 个人主页功能设计文档

## 一、功能概述

个人主页是用户查看个人学习数据、管理个人资料的核心页面，主要包含以下功能模块：

1. **用户信息展示**：显示用户名、账号ID、邮箱等基本信息
2. **头像管理**：支持头像上传、预览和更新
3. **学习统计**：展示总学习时长、完成模块数、笔记数、解决题目数等关键指标
4. **活跃度可视化**：通过热力图展示过去一年的学习活跃度
5. **连续学习天数**：追踪用户的学习连续性

## 二、核心功能设计

### 2.1 头像上传功能

#### 2.1.1 功能描述
用户可以通过点击头像上的上传按钮，选择本地图片文件作为个人头像。系统支持图片预览、格式验证和文件大小限制。

#### 2.1.2 技术实现要点

**前端交互设计：**
- 使用模态框（Modal）提供上传界面，提升用户体验
- 支持拖拽上传和点击上传两种方式
- 实时图片预览功能，用户可在上传前查看效果
- 上传过程中显示加载状态，提供视觉反馈

**文件验证机制：**
- 文件类型验证：仅允许图片格式（JPG、PNG、GIF等）
- 文件大小限制：最大2MB，防止过大文件影响性能
- 客户端预验证：在文件选择时即进行验证，减少无效请求

**后端处理流程：**
- 使用 `secure_filename` 处理文件名，防止路径遍历攻击
- 生成唯一文件名，避免文件名冲突
- 文件存储在 `static/avatars` 目录，便于静态资源管理
- 更新数据库中的用户配置表（UserProfile），记录头像文件名
- 返回头像URL，前端通过时间戳参数避免浏览器缓存

**安全考虑：**
- 文件类型白名单验证
- 文件大小限制防止DoS攻击
- 文件名安全处理防止路径注入
- 用户身份验证，确保只能上传自己的头像

### 2.2 活跃度计算系统

#### 2.2.1 功能描述
活跃度系统通过多维度数据综合计算用户的学习活跃程度，并以可视化热力图的形式展示过去365天的学习情况。

#### 2.2.2 数据收集维度

系统从四个维度收集用户的学习活动数据：

1. **学习时长（权重35%）**
   - 数据来源：`Progress` 表的 `study_time` 字段
   - 统计方式：按日期汇总所有模块的学习时长
   - 时间范围：基于 `last_updated` 字段的日期

2. **笔记数量（权重10%）**
   - 数据来源：`Note` 表的创建和更新记录
   - 统计方式：按日期统计笔记的创建或更新次数
   - 时间字段：优先使用 `updated_at`，若无则使用 `created_at`

3. **完成模块数（权重20%）**
   - 数据来源：`Progress` 表中 `progress_value >= 0.99` 的记录
   - 统计方式：按日期统计完成的模块数量
   - 完成标准：进度值达到99%以上视为完成

4. **解决题目数（权重35%）**
   - 数据来源：`Submission` 表中状态为 'AC' 的记录
   - 统计方式：按日期统计已解决的题目数量，同一题目在同一天多次提交只计一次
   - 去重机制：使用集合（Set）数据结构确保题目ID唯一性

#### 2.2.3 活跃度分数计算算法

**归一化处理：**
- 对每个维度，计算该维度在所有日期中的最大值
- 将当天的数值除以最大值，得到0-1之间的归一化分数
- 处理边界情况：当最大值为0时，该维度分数为0

**加权求和：**
```
总分数 = 学习时长分数 × 0.35 + 笔记数分数 × 0.1 + 完成模块数分数 × 0.2 + 解决题目数分数 × 0.35
```

**等级映射：**
将0-1的总分数映射到0-4的活跃度等级：
- Level 4（最深色）：总分数 ≥ 0.8
- Level 3：总分数 ≥ 0.6
- Level 2：总分数 ≥ 0.4
- Level 1：总分数 ≥ 0.1
- Level 0（最浅色）：总分数 < 0.1 或无活动

#### 2.2.4 数据生成策略

**时间范围：**
- 生成过去365天的完整数据
- 对于没有活动数据的日期，设置为Level 0

**数据完整性：**
- 对于最早活动日期之前的数据，统一设置为无活动
- 确保热力图显示连续的时间序列，避免数据缺失

**性能优化：**
- 一次性查询所有相关数据，在内存中进行聚合计算
- 使用字典（Dictionary）数据结构进行日期索引，提高查询效率
- 避免在循环中进行数据库查询，减少I/O开销

### 2.3 活跃度可视化展示

#### 2.3.1 热力图设计

**布局结构：**
- 采用类似GitHub贡献图的布局方式
- 左侧显示星期标签（周一至周日）
- 顶部显示月份标签
- 主体区域显示365个小方块，每个方块代表一天

**颜色映射：**
- Level 0：`#ebedf0`（浅灰色）- 无活动
- Level 1：`#c6e48b`（浅绿色）- 较少活动
- Level 2：`#7bc96f`（中绿色）- 中等活动
- Level 3：`#239a3b`（深绿色）- 较多活动
- Level 4：`#196127`（最深绿色）- 很多活动

**交互功能：**
- 鼠标悬停显示详细信息：日期、学习时长、笔记数、完成模块数、解决题目数
- 使用CSS过渡效果，提升视觉体验
- 响应式设计，适配不同屏幕尺寸

#### 2.3.2 前端渲染机制

**数据传递：**
- 后端将计算好的活跃度数据序列化为JSON格式
- 通过HTML的 `<script type="application/json">` 标签嵌入到页面中
- 前端JavaScript解析JSON数据，进行渲染

**渲染流程：**
1. 解析后端传递的活跃度数据
2. 动态生成月份标签
3. 为每一天创建对应的DOM元素，设置颜色和交互事件
4. 实现悬停提示功能，显示详细活动信息

### 2.4 学习统计数据

#### 2.4.1 统计指标

系统展示以下关键学习指标：

1. **总学习时长**
   - 计算方式：汇总所有 `Progress` 记录中的 `study_time`
   - 单位：分钟，可转换为小时显示
   - 数据来源：`Progress` 表

2. **完成模块数**
   - 计算方式：统计 `progress_value >= 0.99` 的模块数量
   - 显示格式：已完成数 / 总模块数
   - 数据来源：`Progress` 表

3. **笔记总数**
   - 计算方式：统计用户创建的所有笔记数量
   - 数据来源：`Note` 表

4. **已解决题目数**
   - 计算方式：统计状态为 'AC' 的唯一题目数量（去重）
   - 数据来源：`Submission` 表

5. **最近活跃时间**
   - 计算方式：从 `Progress.last_updated`、`Note.updated_at`、`Submission.submitted_at` 中取最大值
   - 显示格式：相对时间（今天、昨天、N天前）或绝对日期

6. **连续学习天数**
   - 计算方式：从今天开始向前追溯，统计连续有活动的天数
   - 活动定义：在 `Progress`、`Note`、`Submission` 任一表中有记录
   - 算法：按日期排序，从今天开始向前检查日期连续性

#### 2.4.2 数据查询优化

**批量查询策略：**
- 使用SQL聚合函数（SUM、COUNT、MAX）在数据库层面进行计算
- 避免在应用层进行大量数据遍历
- 使用索引优化查询性能

**缓存考虑：**
- 统计数据可考虑缓存，减少重复计算
- 在数据更新时清除相关缓存

## 三、技术架构设计

### 3.1 数据模型设计

**UserProfile 模型：**
- 与 User 模型建立一对一关系
- 存储头像文件名，而非完整路径
- 支持创建时间和更新时间追踪

**数据关联：**
- Progress：用户学习进度记录
- Note：用户学习笔记
- Submission：用户代码提交记录
- 通过 `user_id` 外键关联，确保数据隔离

### 3.2 API 设计

**头像上传API：**
- 路由：`POST /api/upload-avatar`
- 请求格式：`multipart/form-data`
- 响应格式：JSON，包含成功状态、消息和头像URL
- 错误处理：返回详细的错误信息

**个人主页路由：**
- 路由：`GET /profile`
- 权限控制：需要登录（`@login_required` 装饰器）
- 返回：渲染的HTML模板，包含统计数据、活跃度数据等

### 3.3 前端技术栈

**UI框架：**
- Bootstrap 5：提供响应式布局和组件
- Font Awesome：提供图标支持

**交互技术：**
- 原生JavaScript：处理文件上传、数据渲染
- Fetch API：与后端进行异步通信
- DOM操作：动态生成和更新页面元素
