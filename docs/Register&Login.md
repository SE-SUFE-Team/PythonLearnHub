# 登录注册功能设计文档

## 一、功能概述

登录注册系统是平台用户身份认证的核心模块，为用户提供账户注册、登录认证和会话管理功能。系统采用基于Session的认证机制，确保用户数据的安全性和访问控制。

主要功能模块包括：

1. **用户注册**：支持用户名、邮箱、密码注册，自动生成唯一账号ID
2. **用户登录**：基于账号ID和密码的身份验证
3. **会话管理**：使用Flask Session维护用户登录状态
4. **登出功能**：安全清除用户会话信息
5. **权限控制**：通过装饰器实现路由级别的访问控制

## 二、核心功能设计

### 2.1 用户注册功能

#### 2.1.1 功能描述

用户通过填写用户名、邮箱和密码完成账户注册。系统自动生成唯一的8位数字账号ID，作为用户登录凭证。注册过程中进行数据验证和唯一性检查，确保数据完整性和安全性。

#### 2.1.2 技术实现要点

**前端交互设计：**
- 使用响应式表单布局，提供清晰的输入提示
- 实时表单验证：邮箱格式验证、密码匹配验证、密码长度验证
- 提交过程中显示加载状态，防止重复提交
- 注册成功后显示生成的账号ID，提醒用户妥善保管
- 提供友好的错误提示和成功反馈

**数据验证机制：**
- **必填字段验证**：用户名、邮箱、密码不能为空
- **邮箱格式验证**：使用正则表达式验证邮箱格式
- **邮箱唯一性验证**：检查数据库中是否已存在相同邮箱
- **密码长度验证**：密码至少6位字符
- **密码确认验证**：两次输入的密码必须一致
- **客户端预验证**：在提交前进行验证，减少无效请求

**账号ID生成策略：**
- 生成范围：10000000-99999999（8位数字）
- 生成方式：使用随机数生成器生成
- 唯一性保证：生成后检查数据库中是否已存在，如存在则重新生成
- 重试机制：最多尝试100次，避免无限循环
- 错误处理：如果100次尝试后仍无法生成唯一ID，返回服务器错误

**密码安全处理：**
- 使用密码哈希函数对密码进行哈希处理
- 采用PBKDF2算法，确保密码不以明文形式存储
- 哈希后的密码存储在数据库的`password_hash`字段中

**后端处理流程：**
1. 接收前端JSON格式的注册请求
2. 验证必填字段完整性
3. 检查邮箱唯一性
4. 生成唯一的8位数字账号ID
5. 对密码进行哈希处理
6. 创建用户记录并保存到数据库
7. 返回注册成功消息和生成的账号ID

### 2.2 用户登录功能

#### 2.2.1 功能描述

用户使用注册时获得的8位数字账号ID和密码进行登录。系统验证账号和密码的正确性，验证成功后创建用户会话，记录用户登录状态。

#### 2.2.2 技术实现要点

**前端交互设计：**
- 账号输入限制为8位数字，自动过滤非数字字符
- 密码输入支持显示/隐藏切换，提升用户体验
- 登录过程中显示加载状态，提供视觉反馈
- 登录成功后自动跳转到首页
- 提供清晰的错误提示和登录说明

**数据验证机制：**
- **必填字段验证**：账号ID和密码不能为空
- **账号格式验证**：账号必须是8位数字
- **账号存在性验证**：检查数据库中是否存在该账号
- **密码验证**：使用密码哈希验证函数验证密码哈希值

**认证流程：**
1. 接收前端JSON格式的登录请求
2. 验证账号格式（8位数字）
3. 根据账号ID查询用户记录
4. 验证用户是否存在
5. 使用密码哈希验证函数验证密码
6. 验证成功后，将用户ID和用户名存入Session
7. 返回登录成功消息和用户信息

**Session管理：**
- 使用Flask的Session机制维护用户登录状态
- Session中存储`user_id`和`username`两个字段
- Session密钥通过`SECRET_KEY`配置项进行加密
- Session数据存储在服务器端，客户端仅存储Session ID

### 2.3 登出功能

#### 2.3.1 功能描述

用户可以通过登出功能安全地结束当前会话，清除服务器端的Session数据。

#### 2.3.2 技术实现要点

**登出流程：**
- 接收POST请求
- 清除所有Session数据
- 返回登出成功消息

### 2.4 权限控制机制

#### 2.4.1 功能描述

通过装饰器模式实现路由级别的访问控制，确保需要登录才能访问的页面和API接口受到保护。

#### 2.4.2 技术实现要点

**使用方式：**
- 在需要登录保护的路由函数上添加`@login_required`装饰器
- 装饰器检查Session中是否存在`user_id`
- 如果未登录，返回401未授权错误
- 如果已登录，正常执行路由函数

**应用场景：**
- 个人主页：`@app.route('/profile')`
- 学习模块页面：`@app.route('/module/<module_id>')`
- 代码执行接口：`@app.route('/api/execute')`
- 代码提交接口：`@app.route('/api/submit')`
- 笔记管理接口：`@app.route('/api/notes')`
- 头像上传接口：`@app.route('/api/upload-avatar')`

**当前用户获取：**
- 在受保护的路由中，通过Session获取当前登录用户ID
- 通过Session获取当前登录用户名
- 确保数据操作与当前用户关联

## 三、数据模型设计

### 3.1 User模型

**表结构：**
- `id`：主键，Integer类型，8位数字账号ID（10000000-99999999）
- `username`：用户名，String(80)，允许为空，允许重复
- `email`：邮箱地址，String(120)，唯一约束，不允许为空
- `password_hash`：密码哈希值，String(120)，不允许为空

**字段说明：**
- `id`：作为用户唯一标识，用于登录认证
- `username`：用户显示名称，允许重复，便于用户个性化选择
- `email`：用户邮箱，具有唯一性约束，用于账户验证和找回
- `password_hash`：存储经过哈希处理的密码，不存储明文

**关系设计：**
- 与`UserProfile`建立一对一关系
- 与`Progress`建立一对多关系
- 与`Note`建立一对多关系
- 与`Submission`建立一对多关系

### 3.2 Session数据结构

**存储字段：**
- `user_id`：用户ID，用于标识当前登录用户
- `username`：用户名，用于页面显示

**生命周期：**
- 创建：用户成功登录时创建
- 维护：在用户活动期间保持有效
- 销毁：用户登出或Session过期时清除

## 四、API设计

### 4.1 注册相关API

**注册页面路由：**
- 路由：`GET /register`
- 方法：GET
- 权限：无需登录
- 返回：渲染注册页面模板

**注册接口：**
- 路由：`POST /register`
- 方法：POST
- 权限：无需登录
- 请求格式：JSON
  ```json
  {
    "username": "用户名",
    "email": "user@example.com",
    "password": "密码"
  }
  ```
- 响应格式：JSON
  - 成功（201）：
    ```json
    {
      "message": "注册成功",
      "user_id": "12345678"
    }
    ```
  - 失败（400/500）：
    ```json
    {
      "error": "错误信息"
    }
    ```

### 4.2 登录相关API

**登录页面路由：**
- 路由：`GET /login`
- 方法：GET
- 权限：无需登录
- 返回：渲染登录页面模板

**登录接口：**
- 路由：`POST /login`
- 方法：POST
- 权限：无需登录
- 请求格式：JSON
  ```json
  {
    "id": "12345678",
    "password": "密码"
  }
  ```
- 响应格式：JSON
  - 成功（200）：
    ```json
    {
      "message": "登录成功",
      "user_id": "12345678",
      "username": "用户名"
    }
    ```
  - 失败（401）：
    ```json
    {
      "error": "账号或密码错误"
    }
    ```

### 4.3 登出相关API

**登出接口：**
- 路由：`POST /logout`
- 方法：POST
- 权限：建议登录（未登录时清除Session也无影响）
- 请求格式：无请求体
- 响应格式：JSON
  ```json
  {
    "message": "已成功登出"
  }
  ```

### 4.4 用户信息API

**获取当前用户信息：**
- 路由：`GET /me`
- 方法：GET
- 权限：无需登录（但未登录时返回错误）
- 响应格式：JSON
  - 已登录（200）：
    ```json
    {
      "user_id": "12345678",
      "username": "用户名"
    }
    ```
  - 未登录（401）：
    ```json
    {
      "error": "未登录"
    }
    ```

## 五、前端实现细节

### 5.1 注册页面

**表单字段：**
- 用户名：文本输入框，必填
- 邮箱：邮箱输入框，必填，自动验证格式
- 密码：密码输入框，必填，至少6位
- 确认密码：密码输入框，必填，需与密码一致

**交互特性：**
- 实时密码匹配验证
- 邮箱格式验证
- 提交按钮加载状态
- 成功提示显示生成的账号ID
- 错误提示自动滚动到可见区域

**用户体验优化：**
- 表单重置功能
- 友好的提示信息
- 响应式设计，适配移动端
- 提供注册说明和注意事项

### 5.2 登录页面

**表单字段：**
- 账号：文本输入框，必填，限制为8位数字
- 密码：密码输入框，必填，支持显示/隐藏切换

**交互特性：**
- 账号输入自动过滤非数字字符
- 账号格式验证（8位数字）
- 密码显示/隐藏切换
- 提交按钮加载状态
- 登录成功后自动跳转

**用户体验优化：**
- 清晰的登录说明
- 提供注册页面链接
- 友好的错误提示
- 响应式设计

## 六、技术架构设计

### 6.1 后端技术栈

**框架和库：**
- Flask：Web框架
- Werkzeug：密码哈希和安全工具
- SQLAlchemy：ORM数据库操作
- Flask-Session：Session管理（Flask内置）

**关键组件：**
- 密码哈希生成函数
- 密码哈希验证函数
- Session对象
- 登录装饰器

### 6.2 前端技术栈

**UI框架：**
- Bootstrap 5：响应式布局和组件
- Font Awesome：图标支持

**交互技术：**
- 原生JavaScript：表单处理和验证
- Fetch API：异步HTTP请求
- DOM操作：动态更新页面元素

### 6.3 数据库设计

**表结构：**
- `users`表：存储用户基本信息
- 索引：`email`字段建立唯一索引
- 约束：`email`唯一性约束，`password_hash`非空约束

**数据完整性：**
- 外键约束：确保关联数据一致性
- 非空约束：确保关键字段有值
- 唯一约束：确保邮箱唯一性

