{% extends "base.html" %}

{% block title %}åšé¢˜è®­ç»ƒ - Pythonå­¦ä¹ å¹³å°{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-3">
            <h2 class="mb-0"><i class="fas fa-trophy"></i> åšé¢˜è®­ç»ƒ</h2>
            <!-- èƒœåˆ©åº†ç¥å¼€å…³ï¼ˆä¸æ ‡é¢˜å¹³è¡Œï¼‰ -->
            <div class="d-flex align-items-center" title="å¼€å¯åé€šè¿‡é¢˜ç›®ä¼šæœ‰åº†ç¥åŠ¨ç”»ä¸éŸ³æ•ˆ">
                <div class="form-check form-switch mb-0">
                    <input class="form-check-input" type="checkbox" id="celebrate-toggle" checked>
                    <label class="form-check-label mb-0 ms-1 celebrate-label" for="celebrate-toggle">èƒœåˆ©ç»“ç®—åŠ¨ç”»</label>
                </div>
            </div>
        </div>
        <div class="d-flex gap-2 controls-equal-height">
            <label for="problem-select" class="form-label mb-0 d-flex align-items-center text-nowrap">é€‰æ‹©é¢˜ç›®:</label>
            <select id="problem-select" class="form-select" style="min-width: 260px;"></select>
            <button id="refresh-problems" class="btn btn-outline-secondary d-flex align-items-center"><i
                    class="fas fa-rotate me-1"></i> åˆ·æ–°</button>
            <button id="open-submissions" class="btn btn-outline-info d-flex align-items-center"><i
                    class="fas fa-history me-1"></i> æäº¤å†å²</button>
        </div>
    </div>
    <!-- å½“å‰ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆç”¨äºè‰ç¨¿æŒ‰ç”¨æˆ·éš”ç¦»ï¼‰ -->
    <span id="user-context"
        data-user-id="{% if is_logged_in and current_user %}{{ current_user.id }}{% else %}{% endif %}"
        style="display:none;"></span>
    <div class="col-12 mt-2 text-muted">ä»é¢˜ç›®åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªé¢˜ç›®æŸ¥çœ‹è¯¦æƒ…å¹¶è¿›è¡Œä»£ç æäº¤åˆ¤é¢˜</div>
    <div id="problem-load-error" class="col-12 mt-3" style="display:none;"></div>
    <div id="problem-loading" class="col-12 mt-3" style="display:none;">
        <div class="spinner-border text-primary" role="status"><span class="visually-hidden">åŠ è½½ä¸­...</span></div>
        <span class="ms-2 text-muted">æ­£åœ¨åŠ è½½é¢˜ç›®...</span>
    </div>
    <div id="problem-empty" class="col-12 mt-3" style="display:none;">
        <div class="alert alert-light border text-muted"><i class="fas fa-inbox me-2"></i>æš‚æ— é¢˜ç›®</div>
    </div>
    <div id="problem-loaded" class="col-12 mt-3" style="display:none;"></div>
</div>

<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-file-alt"></i> é¢˜ç›®è¯¦æƒ…</h5>
            </div>
            <div class="card-body" id="problem-detail">
                <div class="text-muted">è¯·é€‰æ‹©ä¸Šæ–¹çš„é¢˜ç›®ä»¥æŸ¥çœ‹è¯¦æƒ…</div>
            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-code"></i> ä»£ç æäº¤</h5>
                <div class="d-flex gap-2">
                    <button id="format-code" class="btn btn-sm btn-outline-secondary"><i class="fas fa-magic"></i>
                        æ ¼å¼åŒ–</button>
                    <button id="submit-code" class="btn btn-sm btn-success"><i class="fas fa-paper-plane"></i>
                        æäº¤åˆ¤é¢˜</button>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="oj-editor" style="min-height: 260px;"></div>
                <hr class="my-0">
                <div class="p-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0"><i class="fas fa-terminal"></i> è¿è¡Œ/åˆ¤é¢˜ç»“æœ</h6>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-secondary" id="toggle-error-detail"
                                style="display:none;">
                                <i class="fas fa-chevron-down"></i> æŸ¥çœ‹é”™è¯¯è¯¦æƒ…
                            </button>
                            <button class="btn btn-sm btn-outline-danger" id="clear-result-btn">
                                <i class="fas fa-eraser"></i> æ¸…ç©ºç»“æœ
                            </button>
                        </div>
                    </div>
                    <div id="oj-output" class="code-output-area bg-dark text-light p-3 rounded mb-2">
                        <pre class="mb-0">æäº¤ååœ¨æ­¤æ˜¾ç¤ºåˆ¤é¢˜ç»“æœ...</pre>
                    </div>
                    <div id="oj-failed-detail" class="card" style="display:none;">
                        <div class="card-header py-2"><small class="text-muted">å¤±è´¥ç”¨ä¾‹è¯¦æƒ…</small></div>
                        <div class="card-body p-2">
                            <div class="row g-2">
                                <div class="col-12 col-md-4">
                                    <div class="small text-muted">è¾“å…¥</div>
                                    <pre class="bg-light p-2 rounded small mb-0" id="fd-input"></pre>
                                </div>
                                <div class="col-12 col-md-4">
                                    <div class="small text-muted">æœŸæœ›</div>
                                    <pre class="bg-light p-2 rounded small mb-0" id="fd-expected"></pre>
                                </div>
                                <div class="col-12 col-md-4">
                                    <div class="small text-muted">å®é™…</div>
                                    <pre class="bg-light p-2 rounded small mb-0" id="fd-actual"></pre>
                                </div>
                            </div>
                            <div class="mt-2">
                                <div class="small text-muted">é”™è¯¯</div>
                                <pre class="bg-light p-2 rounded small mb-0" id="fd-error"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="small text-muted" id="submit-info"></div>
            </div>
        </div>
    </div>
</div>

<!-- æäº¤å†å² Modal -->

            <!-- åº†ç¥é®ç½©ï¼ˆå…¨å±€ï¼ŒåŠ¨æ€æ§åˆ¶ï¼‰ -->
            <div id="celebration-overlay" aria-hidden="true">
                <div class="side-rainbow left"></div>
                <div class="side-rainbow right"></div>
                <canvas class="celebration-canvas" style="display:block;"></canvas>
                <div class="celebration-message">
                    <div class="big">ALL RIGHT!</div>
                    <div class="small mt-2" style="font-size:1.2rem; opacity:0.95;">å¤ªæ£’äº†ï¼ä½ å·²é€šè¿‡æ­¤é¢˜ ğŸ‰</div>
                </div>
            </div>

<div class="modal fade" id="submissionModal" tabindex="-1" aria-labelledby="submissionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="submissionModalLabel"><i class="fas fa-history"></i> æäº¤å†å²</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <label for="submission-status-filter" class="form-label mb-0 small text-muted">çŠ¶æ€ç­›é€‰:</label>
                    <select id="submission-status-filter" class="form-select form-select-sm" style="width:auto;">
                        <option value="ALL">å…¨éƒ¨</option>
                        <option value="AC">AC</option>
                        <option value="WA">WA</option>
                        <option value="TLE">TLE</option>
                        <option value="RE">RE</option>
                        <option value="CE">CE</option>
                    </select>
                </div>
                <div id="submission-loading" class="text-center py-4" style="display:none;">
                    <div class="spinner-border text-primary" role="status"><span class="visually-hidden">åŠ è½½ä¸­...</span>
                    </div>
                    <div class="text-muted mt-2">æ­£åœ¨åŠ è½½æäº¤å†å²...</div>
                </div>
                <div id="submission-empty" class="text-center py-4" style="display:none;">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <div class="text-muted">æš‚æ— æäº¤è®°å½•</div>
                </div>
                <div id="submission-error" style="display:none;"></div>
                <div id="submission-list" style="display:none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>

<style>
    .code-output-area {
        min-height: 200px;
        max-height: 360px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        line-height: 1.4;
    }

    .status-badge {
        font-weight: 600;
    }

    /* WA çŠ¶æ€ä¸“ç”¨çº¢è‰²èƒŒæ™¯ */
    .badge-wa {
        background-color: #dc3545 !important;
        color: #ffffff !important;
    }

    /* é»˜è®¤çŠ¶æ€ä¸“ç”¨èƒŒæ™¯ */
    .badge-default {
        background-color: #343a40 !important;
        color: #ffffff !important;
    }

    .submission-item {
        border-left: 4px solid transparent;
    }

    .submission-item:hover {
        background-color: #f8f9fa;
    }

    /* æ§ä»¶ç­‰é«˜ï¼šæ ‡ç­¾ã€ä¸‹æ‹‰ã€æŒ‰é’®é«˜åº¦ä¸€è‡´ */
    .controls-equal-height>* {
        height: 38px;
    }

    .controls-equal-height .form-label {
        padding: 0 8px;
        white-space: nowrap;
    }

    .controls-equal-height .btn {
        display: flex;
        align-items: center;
        white-space: nowrap;
    }

    .controls-equal-height .form-select {
        height: 38px;
    }

    /* é¢˜ç›®è¯¦æƒ…ï¼šè®¾ç½®æœ€ä½é«˜åº¦ï¼Œè¶…å‡ºåè‡ªé€‚åº” */
    #problem-detail {
        min-height: 320px;
    }

    /* å¤±è´¥ç”¨ä¾‹è¯¦æƒ…ï¼šå³ä½¿å†…å®¹ä¸ºç©ºä¹Ÿä¿æŒå¯è§åº•è‰²ä¸é«˜åº¦ */
    #oj-failed-detail pre {
        min-height: 2.25rem;
        /* è¡Œé«˜çº¦ 36px */
    }

    /* é¢˜ç›®è¯¦æƒ…ä¸­çš„ä»£ç å—æ ·å¼ */
    #problem-detail pre {
        border-left: 4px solid #6c757d;
        padding: 0.5rem;
        padding-left: 0.75rem;
        margin: 0.5rem 0;
        background-color: transparent;
    }

    #problem-detail pre code {
        background-color: transparent !important;
    }

    #problem-detail .oj-code-block {
        border-left: 3px solid #d8dce0;
        padding: 0.5rem;
        padding-left: 0.75rem;
        background-color: transparent;
    }

    /* èƒœåˆ©åº†ç¥æ ‡ç­¾å½©è‰²æ¸å˜ */
    .celebrate-label {
        font-weight: 600;
        background: linear-gradient(90deg, #ff6b6b, #ffd166, #06d6a0, #4cc9f0, #b197fc);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
    }

    /* åº†ç¥é®ç½©ä¸åŠ¨ç”» */
    #celebration-overlay {
        position: fixed;
        inset: 0;
        z-index: 2000;
        pointer-events: none;
        display: none;
    }
    /* å¼ºåˆ¶æ˜¾ç¤ºè¦†ç›–å±‚ï¼ˆå¸¦ !important é˜²æ­¢å…¶ä»–æ ·å¼è¦†ç›–ï¼‰ */
    #celebration-overlay.celebration-show {
        display: block !important;
    }

    #celebration-overlay .celebration-canvas {
        position: absolute;
        left: 0; top: 0; width: 100%; height: 100%;
    }

    #celebration-overlay .celebration-message {
        position: absolute;
        top: 30%;
        left: 50%;
        transform: translateX(-50%);
        color: white;
        text-align: center;
        font-weight: 800;
        text-shadow: 0 4px 18px rgba(0,0,0,0.6);
        pointer-events: none;
    }

    @keyframes popIn {
        0% { transform: translateX(-50%) scale(0.6); opacity: 0 }
        60% { transform: translateX(-50%) scale(1.08); opacity: 1 }
        100% { transform: translateX(-50%) scale(1); opacity: 1 }
    }

    #celebration-overlay .celebration-message .big {
        font-size: 6vw;
        line-height: 1;
        animation: popIn 700ms cubic-bezier(.2,.9,.2,1) both, pulse 1200ms ease-in-out 700ms infinite;
    }

    @keyframes pulse {
        0% { transform: translateX(-50%) scale(1); }
        50% { transform: translateX(-50%) scale(1.06); }
        100% { transform: translateX(-50%) scale(1); }
    }

    #celebration-overlay .side-rainbow {
        position: absolute;
        top: 0; bottom: 0;
        width: 12vw;
        pointer-events: none;
        opacity: 0.9;
        mix-blend-mode: screen;
    }
    #celebration-overlay .side-rainbow.left { left: -15vw; background: linear-gradient(180deg, #ff6b6b, #ffcd75, #6bffb8, #6bd3ff); transform: skewX(-10deg); animation: slideInLeft 1s ease forwards; }
    #celebration-overlay .side-rainbow.right { right: -15vw; background: linear-gradient(180deg, #6bd3ff, #6bffb8, #ffcd75, #ff6b6b); transform: skewX(10deg); animation: slideInRight 1s ease forwards; }

    @keyframes slideInLeft { to { left: -2vw; } }
    @keyframes slideInRight { to { right: -2vw; } }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let problemList = [];
    let currentProblemId = null;
    let codeMirrorEditor = null;
    let lastSubmissionsCache = [];
    let currentStatusFilter = 'ALL';
    let currentUserId = null;
    // æ˜¯å¦å¯ç”¨åº†ç¥åŠ¨ç”»ï¼ˆå¯æŒä¹…åŒ–åˆ° sessionStorageï¼‰
    let celebrateEnabled = true;
    const draftSaveDebounceMs = 400;
    let draftSaveTimer = null;

    function getDraftKey(problemId) {
        const uidPart = currentUserId ? String(currentUserId) : 'guest';
        return `oj_draft_${uidPart}_${problemId}`;
    }

    function saveDraft(problemId, code) {
        if (!problemId) return;
        try { sessionStorage.setItem(getDraftKey(problemId), code || ''); } catch (e) { }
    }

    function loadDraft(problemId) {
        if (!problemId) return '';
        try { return sessionStorage.getItem(getDraftKey(problemId)) || ''; } catch (e) { return ''; }
    }

    document.addEventListener('DOMContentLoaded', function () {
        initEditor();
        bindEvents();
        initCelebrationToggle();
        ensureCelebrationOverlay();
        // è¯»å–ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆç”¨äºè‰ç¨¿éš”ç¦»ï¼‰
        const uc = document.getElementById('user-context');
        if (uc && uc.dataset && uc.dataset.userId) {
            currentUserId = uc.dataset.userId;
        }
        loadProblems();
    });

    function initEditor() {
        const editorHost = document.getElementById('oj-editor');
        codeMirrorEditor = CodeMirror(editorHost, {
            mode: 'python',
            theme: 'monokai',
            lineNumbers: true,
            indentUnit: 4,
            tabSize: 4,
            indentWithTabs: false,
            lineWrapping: true,
            autoCloseBrackets: true,
            matchBrackets: true,
            placeholder: "# åœ¨è¿™é‡Œç¼–å†™è§£é¢˜ä»£ç \nprint('Hello OJ')",
            extraKeys: {
                "Ctrl-Enter": function () { submitCurrentCode(); }
            }
        });
        // ç¼–è¾‘æ—¶è‡ªåŠ¨ä¿å­˜è‰ç¨¿ï¼ˆæŒ‰é¢˜ç›®ï¼‰
        codeMirrorEditor.on('change', function () {
            if (!currentProblemId) return;
            if (draftSaveTimer) clearTimeout(draftSaveTimer);
            draftSaveTimer = setTimeout(function () {
                saveDraft(currentProblemId, codeMirrorEditor.getValue());
            }, draftSaveDebounceMs);
        });
    }

    // ç¡®ä¿ overlay åœ¨ document.body ä¸‹ï¼ˆé¿å…è¢«å±€éƒ¨ stacking context é™åˆ¶ï¼‰
    function ensureCelebrationOverlay() {
        try {
            const overlay = document.getElementById('celebration-overlay');
            if (!overlay) return;
            // å¦‚æœ overlay å·²ç»åœ¨ body ä¸‹åˆ™ä¸ç§»åŠ¨
            if (overlay.parentElement !== document.body) {
                document.body.appendChild(overlay);
            }
            // å¼ºåˆ¶æ ·å¼ä¸ºè¦†ç›–å…¨å±çš„ fixed å¸ƒå±€
            overlay.style.position = 'fixed';
            overlay.style.left = '0';
            overlay.style.top = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.zIndex = '2147483647';
            overlay.style.pointerEvents = 'none';
            overlay.style.display = 'none';
            const canvas = overlay.querySelector('canvas');
            if (canvas) {
                canvas.style.display = 'block';
            }
        } catch (e) { console.warn('ensureCelebrationOverlay failed', e); }
    }

    function bindEvents() {
        document.getElementById('refresh-problems').addEventListener('click', loadProblems);
        document.getElementById('problem-select').addEventListener('change', function () {
            const id = this.value;
            if (!id) return;
            const prevId = currentProblemId;
            // åˆ‡æ¢å‰ä¿å­˜ä¸Šä¸€é¢˜è‰ç¨¿
            if (prevId && codeMirrorEditor) {
                saveDraft(prevId, codeMirrorEditor.getValue());
            }
            currentProblemId = id;
            // åˆ‡æ¢åæ¢å¤è¯¥é¢˜è‰ç¨¿
            if (codeMirrorEditor) {
                const draft = loadDraft(id);
                codeMirrorEditor.setValue(draft || '');
            }
            // åˆ‡æ¢é¢˜ç›®æ—¶æ¸…ç©ºè¿è¡Œ/åˆ¤é¢˜ç»“æœä¸é”™è¯¯è¯¦æƒ…
            (function resetResultArea() {
                const outputPre = document.getElementById('oj-output')?.querySelector('pre');
                const infoEl = document.getElementById('submit-info');
                const toggleBtn = document.getElementById('toggle-error-detail');
                const failedPanel = document.getElementById('oj-failed-detail');
                if (outputPre) outputPre.textContent = 'æäº¤ååœ¨æ­¤æ˜¾ç¤ºåˆ¤é¢˜ç»“æœ...';
                if (infoEl) infoEl.textContent = '';
                if (toggleBtn) toggleBtn.style.display = 'none';
                if (failedPanel) failedPanel.style.display = 'none';
            })();
            loadProblemDetail(id);
            loadSubmissions(id);
        });
        document.getElementById('format-code').addEventListener('click', formatCode);
        document.getElementById('submit-code').addEventListener('click', submitCurrentCode);
        const openBtn = document.getElementById('open-submissions');
        if (openBtn) {
            openBtn.addEventListener('click', function () {
                const modal = new bootstrap.Modal(document.getElementById('submissionModal'));
                modal.show();
                loadSubmissions(currentProblemId);
            });
        }

        const filterSel = document.getElementById('submission-status-filter');
        if (filterSel) {
            filterSel.addEventListener('change', function () {
                currentStatusFilter = this.value || 'ALL';
                renderSubmissionsFromCache();
            });
        }

        const clearResultBtn = document.getElementById('clear-result-btn');
        if (clearResultBtn) {
            clearResultBtn.addEventListener('click', function () {
                const output = document.getElementById('oj-output').querySelector('pre');
                const info = document.getElementById('submit-info');
                const toggleBtn = document.getElementById('toggle-error-detail');
                const panel = document.getElementById('oj-failed-detail');
                if (output) output.textContent = 'æäº¤ååœ¨æ­¤æ˜¾ç¤ºåˆ¤é¢˜ç»“æœ...';
                if (info) info.textContent = '';
                if (toggleBtn) toggleBtn.style.display = 'none';
                if (panel) panel.style.display = 'none';
            });
        }

        // åº†ç¥å¼€å…³
        const celebrateToggle = document.getElementById('celebrate-toggle');
        if (celebrateToggle) {
            celebrateToggle.addEventListener('change', function () {
                celebrateEnabled = !!this.checked;
                try { sessionStorage.setItem('oj_celebrate_enabled', celebrateEnabled ? '1' : '0'); } catch (e) { }
            });
        }
    }

    function loadProblems() {
        toggleProblemState('loading');
        fetch('/api/oj/problems')
            .then(r => r.json())
            .then(data => {
                if (!data.success) throw new Error(data.error || 'è·å–é¢˜ç›®å¤±è´¥');
                problemList = data.problems || [];
                renderProblemSelect(problemList);
                toggleProblemState(problemList.length ? 'loaded' : 'empty');
            })
            .catch(err => {
                showProblemError(err.message || 'åŠ è½½å¤±è´¥');
            });
    }

    function renderProblemSelect(list) {
        const sel = document.getElementById('problem-select');
        sel.innerHTML = '';
        if (!list || list.length === 0) return;
        list.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = `${p.id}. ${p.title}`;
            sel.appendChild(opt);
        });
        // é€‰ä¸­ç¬¬ä¸€é¢˜å¹¶åŠ è½½
        sel.value = list[0].id;
        currentProblemId = list[0].id;
        // åˆæ¬¡è¿›å…¥å°è¯•æ¢å¤è‰ç¨¿
        if (codeMirrorEditor) {
            const draft = loadDraft(currentProblemId);
            if (draft) codeMirrorEditor.setValue(draft);
        }
        loadProblemDetail(currentProblemId);
        loadSubmissions(currentProblemId);
    }

    function loadProblemDetail(problemId) {
        const detail = document.getElementById('problem-detail');
        detail.innerHTML = '<div class="text-muted">åŠ è½½ä¸­...</div>';
        fetch(`/api/oj/problem/${problemId}`)
            .then(r => r.json())
            .then(data => {
                if (!data.success) throw new Error(data.error || 'è·å–é¢˜ç›®è¯¦æƒ…å¤±è´¥');
                const p = data.problem;

                // æ„å»ºç¤ºä¾‹çš„markdownå†…å®¹
                let exampleHtml = '';
                if (p.example) {
                    const input = escapeHtml(p.example.input || '');
                    const output = escapeHtml(p.example.output || '');
                    // ä½¿ç”¨HTMLç›´æ¥æ„å»ºï¼Œç¡®ä¿åŠ ç²—æ˜¾ç¤º
                    exampleHtml = `
                        <h6 class="mt-3 mb-2"><strong>ç¤ºä¾‹:</strong></h6>
                        <pre class="oj-code-block"><code><strong>è¾“å…¥ï¼š</strong>${input}\n<strong>è¾“å‡ºï¼š</strong>${output}</code></pre>
                    `;
                }

                // æ„å»ºå‡½æ•°åçš„markdownå†…å®¹
                let functionNameHtml = '';
                if (p.function_name) {
                    const functionName = escapeHtml(p.function_name);
                    // ä½¿ç”¨HTMLç›´æ¥æ„å»º
                    functionNameHtml = `
                        <h6 class="mt-3 mb-2"><strong>å‡½æ•°å:</strong></h6>
                        <pre class="oj-code-block"><code>${functionName}</code></pre>
                    `;
                }

                detail.innerHTML = `
                    <h5 class="mb-2">${escapeHtml(p.title || '')}</h5>
                    <div class="mb-2"><span class="badge bg-primary me-2">ID: ${escapeHtml(p.id)}</span></div>
                    <hr/>
                    <div style="white-space: pre-wrap;">${escapeHtml(p.description || '')}</div>
                    <div class="mt-3"></div>
                    ${exampleHtml}
                    ${functionNameHtml}
                `;

                // å¦‚æœä½¿ç”¨äº†markdown-itï¼Œéœ€è¦è§¦å‘ä»£ç é«˜äº®
                if (window.Prism && (exampleHtml || functionNameHtml)) {
                    Prism.highlightAllUnder(detail);
                }
            })
            .catch(err => {
                detail.innerHTML = `<div class="alert alert-danger">${escapeHtml(err.message || 'åŠ è½½å¤±è´¥')}</div>`;
            });
    }

    function submitCurrentCode() {
        const submitBtn = document.getElementById('submit-code');
        const info = document.getElementById('submit-info');
        const output = document.getElementById('oj-output').querySelector('pre');
        const code = (codeMirrorEditor && codeMirrorEditor.getValue()) || '';
        if (!currentProblemId) {
            info.textContent = 'è¯·å…ˆé€‰æ‹©é¢˜ç›®';
            return;
        }
        if (!code.trim()) {
            info.textContent = 'è¯·å…ˆè¾“å…¥ä»£ç ';
            return;
        }

        const start = Date.now();
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="loading-spinner"></span> æäº¤ä¸­...';
        info.textContent = '';
        output.textContent = 'åˆ¤é¢˜ä¸­...';

        fetch('/api/oj/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ problem_id: currentProblemId, code })
        })
            .then(r => r.json())
            .then(data => {
                const elapsed = ((Date.now() - start) / 1000).toFixed(3);
                if (!data.success) {
                    info.innerHTML = `<i class="fas fa-times text-danger"></i> æäº¤å¤±è´¥ (${elapsed}s)`;
                    output.textContent = data.error || 'æäº¤å¤±è´¥';
                    return;
                }
                const res = data.result || {};
                const status = res.status || 'UNKNOWN';
                const passed = res.passed ?? 0;
                const total = res.total ?? 0;
                const execTime = res.execution_time ?? '-';
                // æå–é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚ ImportError ç­‰ï¼‰
                let errMsg = '';
                if (res.error) errMsg = String(res.error);
                else if (res.failed_case && (res.failed_case.error || res.failed_case.message)) {
                    errMsg = String(res.failed_case.error || res.failed_case.message);
                }
                info.innerHTML = `<i class=\"fas fa-check text-success\"></i> æäº¤æˆåŠŸ (${elapsed}s)`;
                output.textContent = `çŠ¶æ€: ${status}\né€šè¿‡ç”¨ä¾‹: ${passed}/${total}\næ‰§è¡Œæ—¶é—´: ${execTime} ms${errMsg ? `\né”™è¯¯: ${errMsg}` : ''}`;
                renderFailedCase(res.failed_case);
                // å¦‚ä¸º AC å¹¶ä¸”ç”¨æˆ·å¼€å¯åº†ç¥ï¼Œåˆ™æ’­æ”¾åº†ç¥åŠ¨ç”»
                if ((status || '').toUpperCase() === 'AC' && celebrateEnabled) {
                    playCelebration();
                } else {
                    // è‹¥é ACï¼Œåˆ™ç¡®ä¿åœæ­¢å¯èƒ½åœ¨è¿è¡Œçš„åº†ç¥
                    stopCelebration();
                }
                loadSubmissions(currentProblemId);
            })
            .catch(err => {
                info.innerHTML = `<i class="fas fa-times text-danger"></i> ç½‘ç»œé”™è¯¯`;
                output.textContent = err.message || 'ç½‘ç»œé”™è¯¯';
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> æäº¤åˆ¤é¢˜';
            });
    }

    function loadSubmissions(problemId) {
        const loading = document.getElementById('submission-loading');
        const empty = document.getElementById('submission-empty');
        const errorBox = document.getElementById('submission-error');
        const listHost = document.getElementById('submission-list');
        if (loading && empty && errorBox && listHost) {
            loading.style.display = 'block';
            empty.style.display = 'none';
            errorBox.style.display = 'none';
            listHost.style.display = 'none';
            listHost.innerHTML = '';
        }
        const qs = problemId ? `?problem_id=${encodeURIComponent(problemId)}` : '';
        fetch(`/api/oj/submissions${qs}`)
            .then(r => r.json())
            .then(data => {
                if (loading) loading.style.display = 'none';
                if (!data.success) throw new Error(data.error || 'åŠ è½½å¤±è´¥');
                lastSubmissionsCache = data.submissions || [];
                if (lastSubmissionsCache.length === 0) {
                    if (empty) empty.style.display = 'block';
                    return;
                }
                renderSubmissionsFromCache();
            })
            .catch(err => {
                if (loading) loading.style.display = 'none';
                if (errorBox) {
                    errorBox.innerHTML = `<div class="alert alert-danger">${escapeHtml(err.message || 'åŠ è½½å¤±è´¥')}</div>`;
                    errorBox.style.display = 'block';
                }
            });
    }

    function renderSubmissionsFromCache() {
        const listHost = document.getElementById('submission-list');
        const empty = document.getElementById('submission-empty');
        if (!listHost) return;
        listHost.innerHTML = '';
        let filtered = lastSubmissionsCache || [];
        if (currentStatusFilter && currentStatusFilter !== 'ALL') {
            filtered = filtered.filter(s => (s.status || '').toUpperCase() === currentStatusFilter);
        }
        if (filtered.length === 0) {
            if (empty) empty.style.display = 'block';
            return;
        }
        if (empty) empty.style.display = 'none';
        const frag = document.createDocumentFragment();
        filtered.forEach(s => frag.appendChild(renderSubmissionItem(s)));
        listHost.appendChild(frag);
        listHost.style.display = 'block';
    }

    function renderSubmissionItem(s) {
        const div = document.createElement('div');
        div.className = 'card mb-2 submission-item';
        const statusClass = mapStatusToClass(s.status);
        div.style.borderLeftColor = statusClass.color;
        const fullCode = s.code || '';
        // ä¼˜åŒ–é”™è¯¯ä¿¡æ¯åˆ¤æ–­ï¼šåªæœ‰å½“ error_message å­˜åœ¨ä¸”æ ¼å¼åŒ–åä¸ºæœ‰æ•ˆé”™è¯¯ä¿¡æ¯æ—¶æ‰æ˜¾ç¤º
        let err = '';
        // æ£€æŸ¥ error_message æ˜¯å¦å­˜åœ¨ä¸”ä¸ä¸º null/undefined/ç©ºå­—ç¬¦ä¸²/"null"å­—ç¬¦ä¸²
        if (s.error_message && s.error_message !== null && s.error_message !== undefined &&
            String(s.error_message).trim() !== '' && String(s.error_message).toLowerCase() !== 'null') {
            const formattedErr = formatErrorMessage(s.error_message);
            // å†æ¬¡æ£€æŸ¥æ ¼å¼åŒ–åçš„ç»“æœæ˜¯å¦ä¸ºæœ‰æ•ˆé”™è¯¯ä¿¡æ¯
            if (formattedErr && formattedErr.trim() && formattedErr.toLowerCase() !== 'null') {
                err = formattedErr;
            }
        }
        div.innerHTML = `
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge ${statusClass.badge} status-badge">${escapeHtml(s.status || 'â€”')}</span>
                        <small class="text-muted">${escapeHtml(s.submitted_at || '')}</small>
                    </div>
                    <span class="badge bg-secondary" style="background-color: #93aec1 !important;">#${s.id}</span>
                </div>
                <div class="small text-muted">ç”¨ä¾‹: ${s.passed_cases ?? 0}/${s.total_cases ?? 0} | æ—¶é—´: ${s.execution_time ?? '-'} ms</div>
                ${err ? `<div class=\"mt-2\"><span class=\"badge bg-danger me-2\">é”™è¯¯</span><span class=\"text-danger\">${escapeHtml(err)}</span></div>` : ''}
                <pre class="bg-dark text-light p-2 rounded mt-2 mb-0" style="font-size: 12px; max-height: 14em; overflow: auto; white-space: pre-wrap;">${escapeHtml(fullCode)}</pre>
            </div>
        `;
        return div;
    }

    function formatErrorMessage(msg) {
        // å¦‚æœæ¶ˆæ¯æœ¬èº«å°±æ˜¯ null æˆ–æ— æ•ˆå€¼ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
        if (!msg || msg === null || msg === undefined || String(msg).trim() === '' ||
            String(msg).toLowerCase() === 'null') {
            return '';
        }
        try {
            const obj = JSON.parse(msg);
            if (obj && typeof obj === 'object') {
                // æ£€æŸ¥è§£æåçš„å¯¹è±¡ä¸­çš„é”™è¯¯å­—æ®µ
                if (obj.error && obj.error !== null && String(obj.error).toLowerCase() !== 'null') {
                    return String(obj.error);
                }
                if (obj.message && obj.message !== null && String(obj.message).toLowerCase() !== 'null') {
                    return String(obj.message);
                }
                if (obj.detail && obj.detail !== null && String(obj.detail).toLowerCase() !== 'null') {
                    return String(obj.detail);
                }
                if (obj.type && obj.type !== null && String(obj.type).toLowerCase() !== 'null') {
                    return String(obj.type);
                }
            }
            // å¦‚æœè§£æåæ²¡æœ‰æœ‰æ•ˆå­—æ®µï¼Œæ£€æŸ¥åŸå§‹æ¶ˆæ¯
            const msgStr = String(msg);
            if (msgStr.toLowerCase() === 'null' || msgStr.trim() === '') {
                return '';
            }
            return msgStr;
        } catch (_) {
            // JSON è§£æå¤±è´¥ï¼Œç›´æ¥è¿”å›åŸå§‹æ¶ˆæ¯ï¼ˆå¦‚æœæœ‰æ•ˆï¼‰
            const msgStr = String(msg);
            if (msgStr.toLowerCase() === 'null' || msgStr.trim() === '') {
                return '';
            }
            return msgStr;
        }
    }

    function mapStatusToClass(status) {
        const k = (status || '').toUpperCase();
        switch (k) {
            case 'AC': return { badge: 'bg-success', color: '#28a745' };
            case 'WA': return { badge: 'badge-wa', color: '#dc3545' };
            case 'TLE': return { badge: 'bg-warning text-dark', color: '#ffc107' };
            case 'RE': return { badge: 'bg-secondary', color: '#6c757d' };
            case 'CE': return { badge: 'bg-info text-dark', color: '#0dcaf0' };
            default: return { badge: 'badge-default', color: '#343a40' };
        }
    }

    function formatCode() {
        if (!codeMirrorEditor) return;
        const code = codeMirrorEditor.getValue();
        const lines = code.split('\n');
        let indentLevel = 0;
        const out = [];
        lines.forEach(line => {
            const t = line.trim();
            if (!t) { out.push(''); return; }
            if (t.startsWith('else') || t.startsWith('elif') || t.startsWith('except') || t.startsWith('finally')) {
                indentLevel = Math.max(0, indentLevel - 1);
            }
            out.push('    '.repeat(indentLevel) + t);
            if (t.endsWith(':')) indentLevel++;
            if (!t.startsWith(' ') && !t.endsWith(':') && !t.startsWith('else') && !t.startsWith('elif') && !t.startsWith('except') && !t.startsWith('finally')) {
                indentLevel = 0;
            }
        });
        codeMirrorEditor.setValue(out.join('\n'));
    }


    // ===== å¤±è´¥ç”¨ä¾‹è¯¦æƒ…æ¸²æŸ“ä¸æŠ˜å  =====
    function renderFailedCase(failed) {
        const toggleBtn = document.getElementById('toggle-error-detail');
        const panel = document.getElementById('oj-failed-detail');
        const setText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val || ''; };
        if (failed && (failed.input || failed.expected || failed.actual || failed.error || failed.message)) {
            setText('fd-input', stringifyMaybeJson(failed.input));
            setText('fd-expected', stringifyMaybeJson(failed.expected));
            setText('fd-actual', stringifyMaybeJson(failed.actual));
            setText('fd-error', failed.error || failed.message || '');
            if (toggleBtn && panel) {
                toggleBtn.style.display = '';
                panel.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-chevron-down"></i> æŸ¥çœ‹é”™è¯¯è¯¦æƒ…';
                toggleBtn.onclick = () => {
                    const showing = panel.style.display !== 'none';
                    panel.style.display = showing ? 'none' : '';
                    toggleBtn.innerHTML = showing ? '<i class="fas fa-chevron-down"></i> æŸ¥çœ‹é”™è¯¯è¯¦æƒ…' : '<i class="fas fa-chevron-up"></i> æ”¶èµ·é”™è¯¯è¯¦æƒ…';
                };
            }
        } else {
            if (toggleBtn) toggleBtn.style.display = 'none';
            if (panel) panel.style.display = 'none';
        }
    }
    function stringifyMaybeJson(v) {
        if (v == null) return '';
        if (typeof v === 'string') return v;
        try { return JSON.stringify(v); } catch (_) { return String(v); }
    }

    function toggleProblemState(state) {
        document.getElementById('problem-loading').style.display = (state === 'loading') ? 'block' : 'none';
        document.getElementById('problem-empty').style.display = (state === 'empty') ? 'block' : 'none';
        document.getElementById('problem-loaded').style.display = (state === 'loaded') ? 'block' : 'none';
        document.getElementById('problem-load-error').style.display = (state === 'error') ? 'block' : 'none';
    }

    function showProblemError(msg) {
        const box = document.getElementById('problem-load-error');
        box.innerHTML = `<div class="alert alert-danger">${escapeHtml(msg)}</div>`;
        toggleProblemState('error');
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = (text ?? '').toString();
        return div.innerHTML;
    }

    // ====== åº†ç¥åŠ¨ç”»åŠŸèƒ½ (canvas confetti + è¾¹ç¼˜å½©è™¹ + å£°éŸ³) ======
    function initCelebrationToggle() {
        try {
            const stored = sessionStorage.getItem('oj_celebrate_enabled');
            if (stored !== null) celebrateEnabled = (stored === '1');
        } catch (e) { }
        const el = document.getElementById('celebrate-toggle');
        if (el) el.checked = !!celebrateEnabled;
    }

    let _celebrationRAF = null;
    let _confettiState = null;
    function playCelebration() {
        const overlay = document.getElementById('celebration-overlay');
        if (!overlay) return;
        console.debug('playCelebration called');
        // å¼ºåˆ¶ç¡®ä¿å¯è§å¹¶ç½®é¡¶ï¼ˆè°ƒè¯•/å…¼å®¹æ€§ï¼‰
        // ç¡®ä¿æŒ‚è½½åˆ° body é¡¶å±‚ï¼Œé¿å…çˆ¶å…ƒç´  stacking/transform å¹²æ‰°
        try {
            if (overlay.parentElement !== document.body) {
                document.body.appendChild(overlay);
            }
        } catch (_) {}
        // ç›´æ¥ç”¨å†…è”æ ·å¼å¼ºåˆ¶å¯è§ï¼ˆä¸ç”¨æˆ·éªŒè¯ä¸€è‡´ï¼‰
        try { overlay.style.setProperty('display', 'block', 'important'); } catch(_) { overlay.style.display = 'block'; }
        overlay.style.position = 'fixed';
        overlay.style.left = '0';
        overlay.style.top = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.zIndex = '2147483647';
        // åŠ¨ç”»æœŸé—´å…è®¸äº¤äº’ï¼Œç»“æŸåæ¢å¤
        overlay.style.pointerEvents = 'auto';
        overlay.style.opacity = '';
        overlay.style.background = 'rgba(0,0,0,0.15)';
        // ä¿æŒèƒŒæ™¯åŠé€æ˜ï¼Œçªå‡ºçƒŸèŠ±ä¸æ–‡å­—
        const canvas = overlay.querySelector('canvas');
        if (!canvas) return;
        // æ”¯æŒé«˜ DPI å±å¹•ï¼šå°†çœŸå®åƒç´ å°ºå¯¸æŒ‰ devicePixelRatio ç¼©æ”¾
        const dpr = window.devicePixelRatio || 1;
        const cssW = window.innerWidth;
        const cssH = window.innerHeight;
        canvas.style.width = cssW + 'px';
        canvas.style.height = cssH + 'px';
        canvas.width = Math.floor(cssW * dpr);
        canvas.height = Math.floor(cssH * dpr);
        const ctx = canvas.getContext('2d');
        if (!ctx) {
            console.error('celebration: canvas 2d context is null');
            return;
        }
        // å¯é€‰ï¼šä½ å¯æ‰“å¼€ä»¥ä¸‹æ—¥å¿—è§‚å¯Ÿå°ºå¯¸
        // console.debug('overlay rect', overlay.getBoundingClientRect());
        // console.debug('canvas rect', canvas.getBoundingClientRect());
        // å°†åæ ‡ç³»ç¼©æ”¾åˆ° CSS åƒç´ å•ä½
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        // åˆå§‹åŒ–ç²’å­
        const particles = [];
        const colors = ['#ff6b6b','#ffd166','#06d6a0','#4cc9f0','#b197fc','#ff8fab'];
        const cx = cssW / 2;
        const cy = cssH / 3;
        const count = Math.min(300, Math.floor((cssW * cssH) / 2000));
        for (let i = 0; i < count; i++) {
            const angle = Math.random() * Math.PI * 2;
            const speed = 2 + Math.random() * 6;
            particles.push({
                x: cx,
                y: cy,
                vx: Math.cos(angle) * speed * (0.6 + Math.random()*0.8),
                vy: Math.sin(angle) * speed * (0.6 + Math.random()*0.8) - Math.random()*2,
                r: 3 + Math.random()*5,
                c: colors[Math.floor(Math.random()*colors.length)],
                rot: Math.random()*360,
                vr: (Math.random()-0.5)*10
            });
        }
        _confettiState = { ctx, canvas, particles, start: performance.now(), duration: 6000 };
        playVictorySound();
        // è¿ç»­è¡¥å……çƒŸèŠ±ç²’å­ï¼ˆæ›´æŒä¹…çš„ç‡ƒæ”¾æ•ˆæœï¼‰
        let emitterTimer = null;
        function emitBurst() {
            const burstCount = Math.floor(Math.min(120, (cssW * cssH) / 30000));
            for (let i = 0; i < burstCount; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 2 + Math.random() * 6;
                _confettiState.particles.push({
                    x: Math.random()*cssW,
                    y: Math.random()*cssH*0.6,
                    vx: Math.cos(angle) * speed * (0.6 + Math.random()*0.8),
                    vy: Math.sin(angle) * speed * (0.6 + Math.random()*0.8) - Math.random()*2,
                    r: 3 + Math.random()*5,
                    c: colors[Math.floor(Math.random()*colors.length)],
                    rot: Math.random()*360,
                    vr: (Math.random()-0.5)*10
                });
            }
        }
        emitterTimer = setInterval(()=>{ if (_confettiState) emitBurst(); }, 500);
        function step(t) {
            if (!_confettiState) return;
            const s = _confettiState;
            const elapsed = t - s.start;
            // æŒ‰ CSS åƒç´ æ¸…å±
            ctx.clearRect(0,0,cssW, cssH);
            // é€å¸§ç»˜åˆ¶ç²’å­
            for (let p of s.particles) {
                p.x += p.vx; p.y += p.vy; p.vy += 0.12; p.vr += 0.2; p.rot += p.vr;
                const alpha = 1 - (elapsed / s.duration);
                ctx.save();
                ctx.globalAlpha = Math.max(0, alpha);
                ctx.translate(p.x, p.y);
                ctx.rotate(p.rot * Math.PI / 180);
                ctx.fillStyle = p.c;
                ctx.fillRect(-p.r/2, -p.r/2, p.r, p.r*1.6);
                ctx.restore();
            }
            // æµå…‰ï¼ˆè½»å¾®ï¼‰
            if (elapsed < s.duration) {
                _celebrationRAF = requestAnimationFrame(step);
            } else {
                // æ¸…ç†å‘å°„å™¨å¹¶æ¸éšå¤„ç†
                try { if (emitterTimer) clearInterval(emitterTimer); } catch(_){}
                stopCelebration();
            }
        }
        if (_celebrationRAF) cancelAnimationFrame(_celebrationRAF);
        _celebrationRAF = requestAnimationFrame(step);
    }

    function stopCelebration() {
        const overlay = document.getElementById('celebration-overlay');
        if (overlay) {
            try { overlay.style.setProperty('display', 'none', 'important'); } catch(_) { overlay.style.display = 'none'; }
            overlay.style.pointerEvents = 'none';
            overlay.style.background = 'transparent';
            overlay.style.opacity = '';
        }
        if (_celebrationRAF) cancelAnimationFrame(_celebrationRAF);
        _celebrationRAF = null;
        _confettiState = null;
    }

    function playVictorySound() {
        try {
            const audio = new Audio('/static/mp3/bgm.mp3');
            audio.volume = 0.6;
            audio.currentTime = 0;
            audio.play().catch(()=>{});
            // 6 ç§’åæ·¡å‡ºå¹¶åœæ­¢
            setTimeout(()=>{ try{ audio.pause(); }catch(_){} }, 6000);
        } catch (e) { /* å¦‚æœæµè§ˆå™¨ä¸æ”¯æŒ Audio å®‰é™å¤±è´¥ */ }
    }
</script>
{% endblock %}